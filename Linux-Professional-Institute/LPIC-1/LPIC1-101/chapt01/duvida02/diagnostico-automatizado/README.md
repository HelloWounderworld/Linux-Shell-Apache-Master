# **Kit de diagn√≥stico automatizado**

Perfeito üëå ‚Äî abaixo est√° um **kit de diagn√≥stico automatizado completo** em **Bash**, projetado para verificar e gerar um relat√≥rio detalhado sobre o estado de qualquer **m√≥dulo de kernel** no Linux.

Ele identifica:

* se o m√≥dulo existe e est√° carregado,
* se h√° firmware ausente,
* se h√° conflito ou blacklist,
* se est√° assinado,
* se o *vermagic* corresponde ao kernel,
* se faz parte do DKMS,
* e se h√° erros no `dmesg`/`journalctl`.

---

## üß∞ **Script: `analisar_modulo.sh`**

```bash
#!/bin/bash
# ==========================================================
#  Diagn√≥stico avan√ßado de m√≥dulos de kernel Linux
#  Autor: GPT-5
#  Uso: sudo ./analisar_modulo.sh <nome_do_modulo>
# ==========================================================

# Verifica√ß√£o de argumentos
if [ -z "$1" ]; then
    echo "Uso: sudo $0 <nome_do_modulo>"
    exit 1
fi

MOD="$1"
KERNEL="$(uname -r)"
TMPLOG="/tmp/mod_diagnostico_${MOD}.log"

echo "=== Diagn√≥stico de m√≥dulo: $MOD ==="
echo "Kernel atual: $KERNEL"
echo

# 1. Verificar se o m√≥dulo existe
MOD_PATH=$(find /lib/modules/$KERNEL -type f -name "${MOD}.ko*" 2>/dev/null)
if [ -z "$MOD_PATH" ]; then
    echo "[‚ùå] M√≥dulo '${MOD}' n√£o encontrado em /lib/modules/$KERNEL"
    echo "     ‚Üí Verifique se est√° instalado ou se √© compat√≠vel com este kernel."
else
    echo "[‚úÖ] M√≥dulo encontrado: $MOD_PATH"
fi
echo

# 2. Exibir informa√ß√µes b√°sicas
if modinfo $MOD &>/dev/null; then
    echo "=== Informa√ß√µes de modinfo ==="
    modinfo $MOD | egrep "filename|version|vermagic|depends|signer|sig_key|license"
    echo
else
    echo "[‚ö†Ô∏è] 'modinfo' n√£o retornou informa√ß√µes para $MOD"
fi

# 3. Verificar correspond√™ncia de vermagic
VERMAGIC=$(modinfo -F vermagic $MOD 2>/dev/null)
if [ -n "$VERMAGIC" ]; then
    if [[ "$VERMAGIC" == *"$KERNEL"* ]]; then
        echo "[‚úÖ] Vermagic compat√≠vel com o kernel atual ($KERNEL)"
    else
        echo "[‚ùå] Vermagic incompat√≠vel!"
        echo "     ‚Üí Compilado para: $VERMAGIC"
        echo "     ‚Üí Kernel atual:   $KERNEL"
    fi
fi
echo

# 4. Verificar se o m√≥dulo est√° carregado
if lsmod | grep -q "^${MOD}"; then
    echo "[‚úÖ] M√≥dulo '${MOD}' est√° carregado."
else
    echo "[‚ö†Ô∏è] M√≥dulo '${MOD}' n√£o est√° carregado."
    echo "     ‚Üí Tente carregar manualmente com: sudo modprobe ${MOD}"
fi
echo

# 5. Verificar depend√™ncias
echo "=== Depend√™ncias ==="
modinfo -F depends $MOD 2>/dev/null | tr ',' '\n' | sed '/^$/d' | while read dep; do
    if lsmod | grep -q "^${dep}"; then
        echo "  [OK] $dep est√° carregado"
    else
        echo "  [Faltando] $dep n√£o est√° carregado"
    fi
done
echo

# 6. Verificar blacklists
echo "=== Blacklists ==="
grep -R "blacklist.*${MOD}" /etc/modprobe.d/ /lib/modprobe.d/ 2>/dev/null | while read line; do
    echo "  [‚ö†Ô∏è] Encontrado: $line"
done
echo

# 7. Verificar firmware ausente
echo "=== Verifica√ß√£o de firmware ==="
dmesg | grep -i "$MOD" | grep -i "firmware" | tail -n 10
echo

# 8. Verificar assinatura e Secure Boot
if mokutil --sb-state &>/dev/null; then
    SECUREBOOT=$(mokutil --sb-state | awk '{print $2}')
    echo "Secure Boot: $SECUREBOOT"
    if [[ "$SECUREBOOT" == "enabled" ]]; then
        SIG=$(modinfo -F signer $MOD 2>/dev/null)
        if [ -z "$SIG" ]; then
            echo "[‚ö†Ô∏è] Secure Boot ativo e m√≥dulo n√£o assinado ‚Äî pode ser bloqueado."
        else
            echo "[‚úÖ] M√≥dulo assinado por: $SIG"
        fi
    fi
else
    echo "[‚ÑπÔ∏è] mokutil n√£o dispon√≠vel ‚Äî n√£o foi poss√≠vel checar Secure Boot."
fi
echo

# 9. Verificar DKMS
if command -v dkms &>/dev/null; then
    echo "=== Verifica√ß√£o DKMS ==="
    dkms status | grep -i "$MOD" || echo "[‚ÑπÔ∏è] Nenhuma entrada DKMS para $MOD"
else
    echo "[‚ÑπÔ∏è] DKMS n√£o instalado."
fi
echo

# 10. Logs de erros do m√≥dulo
echo "=== √öltimos logs de kernel para '$MOD' ==="
dmesg | grep -i "$MOD" | tail -n 15 > "$TMPLOG"
if [ -s "$TMPLOG" ]; then
    cat "$TMPLOG"
else
    echo "[‚ÑπÔ∏è] Nenhum log recente encontrado para este m√≥dulo."
fi

echo
echo "=== Fim do diagn√≥stico ==="
rm -f "$TMPLOG"
```

---

## üì¶ **Como usar**

1. Salve o script:

   ```bash
   nano analisar_modulo.sh
   ```

   (cole o conte√∫do acima)

2. D√™ permiss√£o de execu√ß√£o:

   ```bash
   chmod +x analisar_modulo.sh
   ```

3. Execute com o m√≥dulo desejado:

   ```bash
   sudo ./analisar_modulo.sh iwlwifi
   ```

   ou, para outro exemplo:

   ```bash
   sudo ./analisar_modulo.sh nvidia
   ```

---

## üìÑ **Sa√≠da esperada (exemplo resumido)**

```
=== Diagn√≥stico de m√≥dulo: iwlwifi ===
Kernel atual: 6.8.0-36-generic

[‚úÖ] M√≥dulo encontrado: /lib/modules/6.8.0-36-generic/kernel/drivers/net/wireless/intel/iwlwifi.ko
=== Informa√ß√µes de modinfo ===
filename: /lib/modules/...
version: 2023.12
vermagic: 6.8.0 SMP mod_unload
signer: Build key
license: GPL

[‚úÖ] Vermagic compat√≠vel com o kernel atual (6.8.0-36-generic)
[‚úÖ] M√≥dulo 'iwlwifi' est√° carregado.
=== Depend√™ncias ===
  [OK] mac80211 est√° carregado
  [OK] cfg80211 est√° carregado
=== Blacklists ===
  (nenhum)
=== Verifica√ß√£o de firmware ===
iwlwifi 0000:02:00.0: loaded firmware version 77.c61391f4.0
Secure Boot: enabled
[‚úÖ] M√≥dulo assinado por: Canonical Ltd. Secure Boot Signing
=== Verifica√ß√£o DKMS ===
[‚ÑπÔ∏è] Nenhuma entrada DKMS para iwlwifi
=== √öltimos logs de kernel para 'iwlwifi' ===
iwlwifi 0000:02:00.0: Detected Intel(R) Wi-Fi 6 AX200
=== Fim do diagn√≥stico ===
```

---

## ‚úÖ **O que ele te entrega**

| Item                        | Verifica√ß√£o |
| --------------------------- | ----------- |
| Exist√™ncia f√≠sica do m√≥dulo | ‚úÖ           |
| Vers√£o e vermagic           | ‚úÖ           |
| Depend√™ncias ausentes       | ‚úÖ           |
| Blacklists aplicadas        | ‚úÖ           |
| Firmware ausente            | ‚úÖ           |
| Assinatura/Secure Boot      | ‚úÖ           |
| Integra√ß√£o com DKMS         | ‚úÖ           |
| Logs de erro no kernel      | ‚úÖ           |

---

## üí° **Uso pr√°tico**

Esse script √© ideal para:

* Troubleshooting de hardware rec√©m-instalado (Wi-Fi, GPU, som, etc.)
* Diagn√≥stico em sistemas minimalistas ou WSL2 customizados
* Ambientes corporativos (quando o autoload de m√≥dulo falha)
* Auditoria de seguran√ßa (checar m√≥dulos n√£o assinados com Secure Boot ativo)

---

# üß† **Script Avan√ßado: `reparar_modulo.sh`**

Perfeito üëå ‚Äî aqui vem a **vers√£o PRO** do kit:
um **‚Äúanalisar & corrigir‚Äù** automatizado em **Bash**, que n√£o s√≥ diagnostica, mas tamb√©m **tenta reparar automaticamente** m√≥dulos de kernel problem√°ticos.

Esse script √© ideal para administradores que querem **agilidade e robustez**, especialmente ao lidar com m√≥dulos que n√£o carregam, est√£o desatualizados, faltam firmware, ou est√£o bloqueados por blacklist.

```bash
#!/bin/bash
# ==========================================================
#  Analisador e reparador autom√°tico de m√≥dulos de kernel
#  Autor: GPT-5
#  Uso: sudo ./reparar_modulo.sh <nome_do_modulo>
# ==========================================================

# ---------- CONFIGURA√á√ïES INICIAIS ----------
MOD="$1"
KERNEL="$(uname -r)"
LOG="/tmp/mod_reparo_${MOD}.log"
REPARO_LOG="/tmp/mod_reparo_exec_${MOD}.log"
FIRMWARE_PKGS=("linux-firmware" "firmware-linux" "firmware-linux-nonfree")

if [ -z "$MOD" ]; then
    echo "Uso: sudo $0 <nome_do_modulo>"
    exit 1
fi

echo "=== An√°lise e reparo autom√°tico do m√≥dulo: $MOD ==="
echo "Kernel atual: $KERNEL"
echo

# ---------- FUN√á√ÉO AUXILIAR ----------
log() { echo -e "$1" | tee -a "$LOG"; }

# ---------- 1. VERIFICAR EXIST√äNCIA ----------
MOD_PATH=$(find /lib/modules/$KERNEL -type f -name "${MOD}.ko*" 2>/dev/null)
if [ -z "$MOD_PATH" ]; then
    log "[‚ùå] M√≥dulo '${MOD}' n√£o encontrado em /lib/modules/$KERNEL."
    log "     Tentando localizar no sistema..."
    MOD_PATH=$(find / -type f -name "${MOD}.ko*" 2>/dev/null | head -n 1)
    if [ -z "$MOD_PATH" ]; then
        log "     ‚Üí N√£o encontrado em lugar algum. Necess√°rio reinstalar/compilar."
        exit 1
    fi
fi
log "[‚úÖ] M√≥dulo encontrado: $MOD_PATH"
echo

# ---------- 2. VERIFICAR SE EST√Å CARREGADO ----------
if lsmod | grep -q "^${MOD}"; then
    log "[‚úÖ] O m√≥dulo '${MOD}' j√° est√° carregado."
else
    log "[‚ö†Ô∏è] M√≥dulo '${MOD}' n√£o est√° carregado ‚Äî tentando carregar..."
    if sudo modprobe "$MOD" 2>>"$REPARO_LOG"; then
        log "[‚úÖ] M√≥dulo carregado com sucesso."
    else
        log "[‚ùå] Falha ao carregar o m√≥dulo via modprobe."
        log "Verifique o log em $REPARO_LOG."
    fi
fi
echo

# ---------- 3. VERIFICAR DEPEND√äNCIAS ----------
log "=== Verifica√ß√£o de depend√™ncias ==="
for dep in $(modinfo -F depends "$MOD" 2>/dev/null | tr ',' ' '); do
    if [ -z "$dep" ]; then
        continue
    fi
    if lsmod | grep -q "^${dep}"; then
        log "  [OK] Depend√™ncia '${dep}' j√° carregada."
    else
        log "  [Faltando] Depend√™ncia '${dep}' ‚Äî tentando carregar..."
        sudo modprobe "$dep" 2>>"$REPARO_LOG" && log "  [‚úÖ] '${dep}' carregada."
    fi
done
echo

# ---------- 4. VERIFICAR BLACKLIST ----------
log "=== Verifica√ß√£o de blacklist ==="
BLACKLIST_LINES=$(grep -R "blacklist.*${MOD}" /etc/modprobe.d/ /lib/modprobe.d/ 2>/dev/null)
if [ -n "$BLACKLIST_LINES" ]; then
    log "[‚ö†Ô∏è] Blacklist encontrada:"
    echo "$BLACKLIST_LINES" | tee -a "$LOG"
    log "‚Üí Removendo temporariamente blacklists..."
    sudo sed -i "/blacklist.*${MOD}/ s/^/#/" /etc/modprobe.d/*.conf 2>/dev/null
    sudo sed -i "/blacklist.*${MOD}/ s/^/#/" /lib/modprobe.d/*.conf 2>/dev/null
    log "[‚úÖ] Blacklists comentadas."
else
    log "[‚úÖ] Nenhuma blacklist para '${MOD}'."
fi
echo

# ---------- 5. VERIFICAR FIRMWARE ----------
log "=== Verifica√ß√£o de firmware ==="
if dmesg | grep -i "$MOD" | grep -qi "firmware"; then
    log "[‚ö†Ô∏è] Poss√≠vel problema de firmware detectado. Tentando reinstalar..."
    for pkg in "${FIRMWARE_PKGS[@]}"; do
        if apt list --installed 2>/dev/null | grep -q "$pkg"; then
            log "  [OK] Pacote $pkg j√° instalado."
        else
            log "  [üîß] Instalando pacote $pkg..."
            sudo apt install -y "$pkg" >>"$REPARO_LOG" 2>&1
        fi
    done
    log "[‚úÖ] Verifica√ß√£o de firmware conclu√≠da."
else
    log "[‚úÖ] Nenhum erro de firmware aparente nos logs."
fi
echo

# ---------- 6. VERIFICAR ASSINATURA E SECURE BOOT ----------
if mokutil --sb-state &>/dev/null; then
    SECUREBOOT=$(mokutil --sb-state | awk '{print $2}')
    log "Secure Boot: $SECUREBOOT"
    if [[ "$SECUREBOOT" == "enabled" ]]; then
        SIG=$(modinfo -F signer $MOD 2>/dev/null)
        if [ -z "$SIG" ]; then
            log "[‚ö†Ô∏è] Secure Boot ativo e m√≥dulo n√£o assinado."
            log "     ‚Üí Op√ß√µes:"
            log "       - Desativar Secure Boot temporariamente, ou"
            log "       - Assinar o m√≥dulo com sua chave MOK."
        else
            log "[‚úÖ] M√≥dulo assinado por: $SIG"
        fi
    fi
else
    log "[‚ÑπÔ∏è] mokutil n√£o dispon√≠vel ‚Äî n√£o foi poss√≠vel checar Secure Boot."
fi
echo

# ---------- 7. REGERAR DEPEND√äNCIAS E RECARREGAR ----------
log "[üîß] Regenerando depend√™ncias com depmod..."
sudo depmod -a
log "[üîÅ] Recarregando m√≥dulo..."
sudo modprobe -r "$MOD" 2>/dev/null
if sudo modprobe "$MOD" 2>>"$REPARO_LOG"; then
    log "[‚úÖ] M√≥dulo recarregado com sucesso."
else
    log "[‚ùå] Falha ao recarregar o m√≥dulo. Verifique $REPARO_LOG."
fi
echo

# ---------- 8. VALIDAR STATUS FINAL ----------
log "=== Status final ==="
if lsmod | grep -q "^${MOD}"; then
    log "[‚úÖ] M√≥dulo '$MOD' ativo e carregado."
else
    log "[‚ùå] M√≥dulo '$MOD' ainda n√£o est√° ativo."
fi
echo

# ---------- 9. EXIBIR ERROS DO KERNEL ----------
log "=== √öltimos logs de kernel relacionados ==="
dmesg | grep -i "$MOD" | tail -n 10 | tee -a "$LOG"
echo

# ---------- 10. FINALIZA√á√ÉO ----------
log "=== Reparo conclu√≠do ==="
echo
log "‚Üí Relat√≥rio salvo em: $LOG"
log "‚Üí Log detalhado de execu√ß√£o: $REPARO_LOG"
```

---

## ‚öôÔ∏è **Como usar**

1. Crie o arquivo:

   ```bash
   nano reparar_modulo.sh
   ```

   (cole o script acima)

2. D√™ permiss√£o de execu√ß√£o:

   ```bash
   chmod +x reparar_modulo.sh
   ```

3. Execute com o m√≥dulo desejado:

   ```bash
   sudo ./reparar_modulo.sh iwlwifi
   ```

---

## üìÑ **Sa√≠da esperada (exemplo)**

```
=== An√°lise e reparo autom√°tico do m√≥dulo: iwlwifi ===
Kernel atual: 6.8.0-36-generic

[‚úÖ] M√≥dulo encontrado: /lib/modules/6.8.0-36-generic/kernel/drivers/net/wireless/intel/iwlwifi.ko
[‚ö†Ô∏è] M√≥dulo 'iwlwifi' n√£o est√° carregado ‚Äî tentando carregar...
[‚úÖ] M√≥dulo carregado com sucesso.

=== Verifica√ß√£o de depend√™ncias ===
  [OK] cfg80211 j√° carregada.
  [OK] mac80211 j√° carregada.

=== Verifica√ß√£o de firmware ===
[‚úÖ] Nenhum erro de firmware aparente nos logs.

Secure Boot: enabled
[‚úÖ] M√≥dulo assinado por: Canonical Ltd. Secure Boot Signing

[üîß] Regenerando depend√™ncias com depmod...
[üîÅ] Recarregando m√≥dulo...
[‚úÖ] M√≥dulo recarregado com sucesso.

=== Status final ===
[‚úÖ] M√≥dulo 'iwlwifi' ativo e carregado.
```

---

## üí° **O que ele faz automaticamente**

| A√ß√£o                            | Descri√ß√£o                                       |
| ------------------------------- | ----------------------------------------------- |
| ‚úÖ Analisa m√≥dulo e depend√™ncias | Usa `modinfo`, `lsmod`, `depmod`                |
| üîß Recarrega m√≥dulo             | Executa `modprobe -r` + `modprobe`              |
| üö´ Remove blacklists            | Comenta entradas conflitantes                   |
| üì¶ Reinstala firmware           | Usa `apt install linux-firmware`                |
| üîê Verifica Secure Boot         | Avisa sobre m√≥dulos n√£o assinados               |
| üß† Regenera depend√™ncias        | Executa `depmod -a`                             |
| üìã Gera logs                    | Salva relat√≥rios em `/tmp/mod_reparo_<mod>.log` |

---

## üß© **Extras sugeridos**

Se quiser, posso gerar uma **vers√£o 3.0** que:

* **detecta automaticamente o m√≥dulo** de um *device ID* (`lspci -nn` / `lsusb`);
* permite **modo n√£o interativo** (para execu√ß√£o em larga escala, tipo servidores);
* e exporta um **relat√≥rio JSON** de diagn√≥stico.